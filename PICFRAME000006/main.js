/*
 * @packet main; 
 * @require util.touch;
 * @css style.main;
 * @template template.temp;
 */Module({name:"picplayer",extend:"viewgroup",className:"picplayer",layout:module.getTemplate("@temp","picplayer"),option:{},init:function(){this.addChild({type:"@.picframe",container:this.dom}),this._width=this.dom.width()},event_progress:function(t){this.finders("loading").html("Loading... "+t.data+" %"),t.stopPropagation()},event_ready:function(){this.finders("loading").remove();var t=this,i=this.getChildAt(0);this.dom.touch(function(e){if("down"===e.action)t._move=!0;else if("move"===e.action){if("left"===e.direction||"right"===e.direction){var h=Math.round(e.xis/t._width*i.getFrameSize());i.gotoAndStop(h)}}else t._move=!1})}}),Module({name:"picframe",extend:"view",className:"picframe",template:module.getTemplate("@temp","picframe"),option:{basePath:"images/fd.",from:1,to:330,suffix:"jpg",type:"fit",time:50,autoplay:!1,background:"black"},init:function(){this.current=0,this.render();var t=this.finders("canvas").get(0);this._width=this.dom.width(),this._height=this.dom.height(),t.width=this._width,t.height=this._height,this.canvas=t,this.ctx=t.getContext("2d"),this.dom.css("background",this.option.background);var i=this;this.loadPics().done(function(){i.option.autoplay?i.play():i.gotoAndStop(0)})},loadPics:function(){for(var t=this,i=$.promise(),e=[],h=this.option.from;h<=this.option.to;h++){var n=h+"",o="";o=1===n.length?"00"+h:2===n.length?"0"+h:h,e.push(this.option.basePath+o+"."+this.option.suffix)}var a=$.queue(),r=[];a.complete(function(){t.images=r,i.resolve(),t.dispatchEvent("ready")}),a.progress(function(i){t.dispatchEvent("progress",Math.round(i.runed/i.total*100))});for(var h in e)a.add(function(t,i){var e=this;$.loader().image(i,function(){r.push(this),e.next()})},function(){this.next()},e[h]);return a.run(),t.dispatchEvent("start"),i},getFrameSize:function(){return this.images.length},renderFrame:function(){var t=this.images[this.current],i=this.option.type,e=this;if(this.ctx.clearRect(0,0,this._width,this._height),"fit"===i){var h,n=0,o=0,a=0;t.width>e._width?(n=e._width,h=t.height/t.width*n,h>e._height&&(h=e._height,n=t.width/t.height*h)):(h=e._height,n=t.width/t.height*h,n>e._width&&(n=e._width,h=t.height/t.width*n)),o=(e._width-n)/2,a=(e._height-h)/2,e.ctx.drawImage(t,o,a,n,h)}else if("repeat"===i){for(var n=e._width,h=e._height,o=0,a=0;;)if(e.ctx.drawImage(t,o,a,t.width,t.height),o+=t.width,o>n){if(a+=t.height,!(h>a))break;o=0}}else if("fill"===i)e.ctx.drawImage(t,0,0,e._width,e._height);else if("center"===i){var n=t.width,h=t.height,o=0,a=0;o=(e._width-n)/2,a=(e._height-h)/2,e.ctx.drawImage(t,o,a,n,h)}this.dispatchEvent("enterframe",this.current)},gotoAndStop:function(t){t>=0&&t<this.images.length&&(this.current=t,this.renderFrame())},gotAndPlay:function(t){this.gotoAndStop(t),this.play()},play:function(){var t=this;this._interval||(this._interval=setInterval(function(){var i=t.current+1;i>=t.images.length&&(i=0),t.current=i,t.renderFrame()},this.option.time))},stop:function(){clearInterval(this._interval),this._interval=!1},event_enterframe:function(t){t.stopPropagation()}});